name: Organize Blog Posts by Slug

on:
  push:
    paths:
      - "**/*.md"

jobs:
  organize:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Organize by slug keyword
        run: |
          import os, yaml, shutil

          SLUG_KEYWORDS = {
              "productivity": "productivity",
              "java": "java",
              "system-design": "system-design",
              "thoughts": "thoughts",
              "side-project": "side-project",
              "algorithms": "algorithms",
          }

          # Phase 1: collect metadata for all markdown files (do not rename/move yet)
          md_files = [f for f in os.listdir(".") if f.endswith(".md")]
          entries = []  # (original_filename, slug, dest_folder_or_None)

          for filename in md_files:
              try:
                  with open(filename, 'r', encoding='utf-8') as fh:
                      lines = fh.readlines()
              except FileNotFoundError:
                  # file may have been moved by something else; skip
                  print(f"Skipping missing file (already moved): {filename}")
                  continue

              if not lines or lines[0].strip() != "---":
                  print(f"Skipping {filename}: no YAML frontmatter")
                  continue

              frontmatter_lines = []
              for line in lines[1:]:
                  if line.strip() == "---":
                      break
                  frontmatter_lines.append(line)

              try:
                  meta = yaml.safe_load("".join(frontmatter_lines)) or {}
              except Exception as e:
                  print(f"Failed to parse frontmatter for {filename}: {e}")
                  continue

              slug = meta.get("slug") or ""
              if not slug:
                  print(f"No slug found for {filename}; skipping")
                  continue

              dest = None
              for keyword, folder in SLUG_KEYWORDS.items():
                  if keyword in slug:
                      dest = folder
                      break

              entries.append((filename, slug, dest))

          # Phase 2: perform safe renames and moves
          for original, slug, dest_folder in entries:
              new_basename = f"{slug}.md"

              # ensure we do not overwrite an existing file unintentionally;
              # if new_basename exists and is different from original, append numeric suffix
              candidate = new_basename
              counter = 1
              while os.path.exists(candidate) and candidate != original:
                  candidate = f"{slug}-{counter}.md"
                  counter += 1
              new_filename = candidate

              try:
                  os.rename(original, new_filename)
                  print(f"Renamed {original} -> {new_filename}")
              except FileNotFoundError:
                  print(f"Rename skipped; {original} not found.")
                  continue
              except Exception as e:
                  print(f"Rename error for {original} -> {new_filename}: {e}")
                  continue

              if dest_folder:
                  os.makedirs(dest_folder, exist_ok=True)
                  dest_path = os.path.join(dest_folder, new_filename)
                  try:
                      shutil.move(new_filename, dest_path)
                      print(f"Moved {new_filename} to {dest_folder}/")
                  except Exception as e:
                      print(f"Failed to move {new_filename} to {dest_folder}: {e}")
              else:
                  print(f"No matching slug keyword found for: {new_filename}")
        shell: python

      - name: Commit organized files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Organized posts by slug keywords" || echo "No changes"
          git pull --rebase origin main
          git push
